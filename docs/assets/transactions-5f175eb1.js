var e=Object.defineProperty,t=(t,a,s)=>(((t,a,s)=>{a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s})(t,"symbol"!=typeof a?a+"":a,s),s);import{v as a,S as s,$ as n,T as o,a as l,b as i,c,d as r,e as d}from"./index-d25e61ad.js";import{e as u}from"./event-emitter-eaaf34fa.js";import{m as p,F as m}from"./form-rule-builder-31f651bc.js";import{c as b}from"./dialog-47ec0b44.js";class f{constructor(e){t(this,"page"),t(this,"pagesize"),t(this,"total"),this.page=1,this.pagesize=25,this.total=1,e&&Object.assign(this,e)}}const g=()=>{const{div:e,label:t,input:o,button:l,small:i,form:c,select:r,option:d}=a.tags,{tags:p}=n.tag,m=a.state(!1);let b=new s;let f=r({class:"input",onchange:e=>b.tag=e.target.value},d({value:""},""),d({value:"BLANK"},"[BLANK]"));return a.derive(()=>{let e=new Array;e=p.val.map(e=>d({value:e},e)),a.add(f,e)}),e({class:"box"},c(e({class:"is-pulled-right"},l({type:"button",onclick:()=>m.val=!m.val},i("Advance search"))),e({class:"is-clearfix"}),e({class:"columns"},e({class:"column"},e({class:"field"},t({class:"field"},"Search"),e({class:"control"},o({class:"input",type:"text",placeholder:"Search..",oninput:e=>b.search=e.target.value})))),e({class:"column"},e({class:"field"},t({class:"field"},"Tags"),e({class:"control"},f)))),e({class:()=>m.val?"columns":"is-hidden"},e({class:"column"},t({class:"field"},"Date From"),o({class:"input",type:"date",onblur:e=>b.date.start=e.target.value})),e({class:"column"},t({class:"field"},"Date To"),o({class:"input",type:"date",onblur:e=>b.date.end=e.target.value})),e({class:"column"},t({class:"field"},"Amount"),o({class:"input",type:"number",placeholder:"start",oninput:e=>b.amount.start=e.target.value})),e({class:"column"},t({class:"field"},"Amount"),o({class:"input",type:"number",placeholder:"end",oninput:e=>b.amount.end=e.target.value}))),e({class:"buttons"},l({class:"button is-primary",type:"button",onclick:()=>u.emit("search",b)},"Apply"),l({class:"button is-secondary",type:"reset",onclick:()=>{b=new s}},"Reset"))))},h=(e,t)=>{const{div:s,header:n,p:o,section:l,footer:i,button:c}=a.tags,r=()=>p.close(e.id);return s({id:e.id,class:"modal"},s({class:"modal-background"}),s({class:"modal-card"},n({class:"modal-card-head"},o({class:"modal-card-title"},e.title),c({class:"delete",ariaLabel:"close",onclick:r})),l({class:"modal-card-body"},t),()=>e.footer?i({class:"modal-card-foot"},s({class:"buttons"},c({class:"button is-success",onclick:()=>u.emit("action")},"Save"),c({class:"button",onclick:r},"Cancel"))):s()))},v=()=>{const{div:e,input:t,label:s,span:i,strong:c}=a.tags;function r(e){e.preventDefault(),e.stopPropagation(),document.getElementsByClassName("dropzone")[0].classList.remove("is-dragover")}function d(e){const t=new FileReader;t.addEventListener("load",e=>{const t=e.target.result;if(t&&"string"==typeof t){let e=0,a=new Array;const s=new Array;t.replaceAll("\r","").split("\n").forEach(t=>{var n;if(0===e)a=t.replaceAll('"',"").replace("Date","dttm").toLowerCase().split(",");else{const e=t.replaceAll('"',"").split(",");let l=0;const i={};for(const t of a)i[t]=e[l],l+=1;i.amount=parseFloat(null==(n=i.amount)?void 0:n.toString());let c=new o(i);c.dttm&&c.name&&s.push(c)}e+=1}),n.transaction.saveTransactions(s).then(e=>{200===e&&(document.getElementsByClassName("dropzone")[0].classList.remove("is-uploading"),document.getElementsByClassName("dropzone")[0].classList.add("is-success"),window.setTimeout(()=>window.location.reload(),1e3))})}}),t.readAsText(e)}return e({class:()=>window.FileReader?"dropzone has-advanced-upload":"dropzone",style:"text-align: center;",ondragover:e=>{e.preventDefault(),e.stopPropagation(),document.getElementsByClassName("dropzone")[0].classList.add("is-dragover")},ondrop:e=>function(e){e.preventDefault(),document.getElementsByClassName("dropzone")[0].classList.remove("is-dragover"),document.getElementsByClassName("dropzone")[0].classList.add("is-uploading"),e.dataTransfer&&e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{if("file"===e.kind){const t=e.getAsFile();t&&d(t)}}):e.dataTransfer&&e.dataTransfer.files&&[...e.dataTransfer.files].forEach(e=>{d(e)})}(e),ondragend:e=>r(e),ondragleave:e=>r(e)},e({class:"dropzone__input"},l({class:"dropzone__icon"}),t({type:"file",name:"files[]",id:"file",class:"dropzone__file",multiple:"",onchange:()=>function(){const e=document.getElementById("file");e&&e.files&&[...e.files].forEach(e=>{"text/csv"==e.type&&d(e)})}()}),s({for:"file"},c("Choose a file"),i({class:"dropzone__dragndrop"}," or drag it here"),".")),e({class:"dropzone__uploading"},"Uploading..."),e({class:"dropzone__success"},"Done!"),e({class:"dropzone__error"},"Error"))},y=()=>{const{div:e,button:t}=a.tags;return h({id:"ImportModal",title:"Import Transactions"},e(t({class:"button is-small mb-4",onclick:()=>function(){const e=new Blob(['"Date","Transaction","Name","Memo","Amount"\n"2025-01-01","DEBIT","DEBIT PURCHASE -VISA KROGER #0001 ANYTOWN USA","Download from bank","-99.91"\n"2025-01-02","DEBIT","DEBIT PURCHASE -VISA WENDY #0001 ANYTOWN USA","Download from bank","-29.32"'],{type:"text/plain"}),t=document.createElement("a");t.href=window.URL.createObjectURL(e),t.download="template.csv",t.click()}()},"CSV template"),v()))},w=e=>{const{div:t,table:s,thead:l,tbody:f,tfoot:g,tr:v,th:w,td:k,button:A,input:T,select:x,option:z,span:D}=a.tags,{tags:S}=n.tag,{transaction:_}=n.transaction;let M=a.state(0),E=a.state(0),I=a.state(0);function N(){n.transaction.saveTransaction().then(()=>{M.val=0})}u.subscribe("edit",e=>async function(e){_.val=new o,e>0&&await n.transaction.getTransactionById(e);p.open("TransactionModal")}(e)),u.subscribe("remove",e=>function(e){e>0&&b({title:"Confirm",message:"Are you sure you want to remove this transaction?",type:"yesno"}).then(t=>{t&&n.transaction.removeTransaction(e).then(()=>{window.location.reload()})})}(e)),u.subscribe("tag",t=>{let a=e.transactions.find(e=>e.id==t)??new o;n.tag.setRule(a.name,{amount:Math.abs(a.amount),tag:""}),p.open("RuleBuilderModal")}),I.val=0;const B=new Array;return e.transactions.forEach(e=>{I.val=I.val+parseFloat(e.amount.toString()),B.push(v(k(t({class:"text-nowrap"},e.dttm)),k(e.transaction),k(t({style:"max-width:350px",class:"text-ellipsis",title:e.name},e.name)),k(()=>M.val!=e.id?A({class:"button is-small text-ellipsis",style:"max-width:130px;display:block",title:e.memo,onclick:()=>{_.val=e,M.val=e.id}},e.memo):T({type:"text",class:"input",value:()=>e.memo,oninput:t=>{e.memo=t.target.value,_.val.memo=e.memo},onblur:()=>N(),onkeyup:e=>{e.key.includes("Enter")&&N()}})),k(e.amount),k(()=>E.val!=e.id?A({class:"button is-small",onclick:()=>{_.val=e,E.val=e.id}},e.tag):x({class:"input",onblur:()=>E.val=0,onchange:t=>{e.tag=t.target.value,_.val.tag=e.tag,n.transaction.saveTransaction().then(()=>{E.val=0})}},z({value:""},""),S.val.map(t=>z({value:t,selected:e.tag===t},t)))),k((e=>{const{div:t,button:s,a:n,hr:o}=a.tags;let l=a.state(!1);return t(s({type:"button",onclick:()=>{l.val=!l.val}},i()),t({class:()=>l.val?"mini-menu active":"mini-menu"},t({class:""},n({class:"mini-menu-item",href:"#",onclick:t=>{t.preventDefault(),l.val=!1,u.emit("edit",e.id)}},c(),"Edit Transaction"),n({class:"mini-menu-item",href:"#",onclick:t=>{t.preventDefault(),l.val=!1,u.emit("tag",e.id)}},r(),"Create Tag"),o({class:"mini-menu-divider"}),n({style:"color: hsl(348deg,100%,70%)",class:"mini-menu-item",href:"#",onclick:t=>{t.preventDefault(),l.val=!1,u.emit("remove",e.id)}},d(),"Delete Transaction"))))})({id:e.id}))))}),t({},t({class:"column"},t({class:"table-container"},s({class:"table is-striped is-narrow is-fullwidth is-hoverable"},l(v(w("Date"),w("Transaction"),w("Name"),w("Memo"),w("Amount"),w("Tag"),w(A({class:"button is-secondary is-small",onclick:()=>p.open("ImportModal")},"Import")))),()=>0===e.transactions.length?f(v(k({colSpan:8},"No records found."))):f(B),g(v(k({colSpan:4},""),k({colSpan:3},D({class:"has-text-weight-bold"},"$",Math.abs(I.val).toFixed(2)))))))),(()=>{const{div:e,label:t,input:s,select:l,option:i}=a.tags,{transaction:c}=n.transaction,{tags:r}=n.tag;u.subscribe("action",function(){n.transaction.saveTransaction().then(()=>{p.close("TransactionModal"),c.val=new o})});let d=l({class:"input",onchange:e=>c.val.tag=e.target.value},i({value:""},""));return a.derive(()=>{let e=new Array;e=r.val.map(e=>i({value:e,selected:()=>c.val.tag===e},e)),a.add(d,e)}),h({id:"TransactionModal",title:"Transaction Properties",footer:!0},e(e(t("Date"),s({type:"text",class:"input",disabled:!0,value:()=>c.val.dttm})),e(t("Transaction"),s({type:"text",class:"input",disabled:!0,value:()=>c.val.transaction})),e(t("Name"),s({type:"text",class:"input",disabled:!0,value:()=>c.val.name})),e(t("Memo"),s({type:"text",class:"input",placeholder:"Enter memo.",value:()=>c.val.memo,oninput:e=>c.val.memo=e.target.value})),e(t("Amount"),s({type:"text",class:"input",disabled:!0,value:()=>c.val.amount})),e(t("Tag"),d)))})(),y(),h({id:"RuleBuilderModal",title:"Tag Rule Builder"},m()))},k=e=>{const{div:t,nav:n,ul:o,li:l,span:i,a:c,select:r,option:d}=a.tags;let p=new s;const m=new f(e);let b=a.state(new Array);let g=a.state(1),h=a.state(m.total);if(h.val>3){let e=Math.ceil(1.5)-1,t=m.page-e,a=m.page+e;t<2?(a=3,t=1):a>m.total-2&&(a=m.total,t=m.total-3+1),g.val=t,h.val=a}b.val=[],g.val>2?(b.val.push(1),b.val.push(0)):g.val>1&&b.val.push(1);for(let a=g.val;a<=h.val;a++)b.val.push(a);return h.val<m.total&&(b.val.push(0),b.val.push(m.total)),t({class:"mb-4"},t({class:"is-pulled-right"},r({class:"input",title:"page size",onchange:e=>{p.page=1,p.pagesize=parseInt(e.target.value,10),u.emit("page",p)}},[25,50,100].map(t=>d({selected:(null==e?void 0:e.pagesize)==t},t)))),n({class:"pagination is-small is-rounded",role:"navigation",ariaLabel:"pagination"},o({class:"pagination-list"},b.val.map(e=>l(e?c({href:"#",ariaLabel:`goto page ${e}`,class:()=>e===m.page?"pagination-link is-current":"pagination-link",onclick:t=>{t.preventDefault(),p.page=e,u.emit("page",p)}},e):i({class:"pagination-ellipsis"},"â€¦"))))))},A=async()=>{const{div:e}=a.tags;let t=a.state(!1),o=a.state({filter:new s,data:new Array});function l(e,a=0){switch(a){case 0:o.val.filter=e;break;case 1:o.val.filter.page=e.page,o.val.filter.pagesize=e.pagesize}t.val=!0,n.transaction.getTransactions(o.val.filter).then(e=>{o.val=e,t.val=!1})}return u.subscribe("search",e=>l(e)),u.subscribe("page",e=>l(e,1)),o.val=await n.transaction.getTransactions(),e({class:"container mt-2"},g(),()=>t.val?e({class:"skeleton-block"}):e(k({page:o.val.filter.page,pagesize:o.val.filter.pagesize,total:o.val.filter.pagecount}),w({transactions:o.val.data}),k({page:o.val.filter.page,pagesize:o.val.filter.pagesize,total:o.val.filter.pagecount})))};export{A as Transactions};
