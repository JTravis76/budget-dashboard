var e=Object.defineProperty,s=(s,t,a)=>(((s,t,a)=>{t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a})(s,"symbol"!=typeof t?t+"":t,a),a);import{v as t,S as a,$ as l,T as n,a as o,b as i,c,d as r,e as d}from"./index-81412148.js";import{e as u}from"./event-emitter-eaaf34fa.js";import{m as p,F as m}from"./form-rule-builder-3f0d1b86.js";import{c as g}from"./dialog-aabe9f9e.js";class b{constructor(e){s(this,"page"),s(this,"pagesize"),s(this,"total"),this.page=1,this.pagesize=25,this.total=1,e&&Object.assign(this,e)}}const{div:f,label:h,input:v,button:y,small:w,form:k,select:x,option:z}=t.tags,{tags:T}=l.tag,_=t.state(!1);let A=new a;let M=x({class:"input",onchange:e=>A.tag=e.target.value},z({value:""},""));t.derive(()=>{let e=new Array;e=T.val.map(e=>z({value:e},e)),t.add(M,e)});const S=()=>f({class:"box"},k(f({class:"is-pulled-right"},y({type:"button",onclick:()=>_.val=!_.val},w("Advance search"))),f({class:"is-clearfix"}),f({class:"columns"},f({class:"column"},f({class:"field"},h({class:"field"},"Search"),f({class:"control"},v({class:"input",type:"text",placeholder:"Search..",oninput:e=>A.search=e.target.value})))),f({class:"column"},f({class:"field"},h({class:"field"},"Tags"),f({class:"control"},M)))),f({class:()=>_.val?"columns":"is-hidden"},f({class:"column"},h({class:"field"},"Date From"),v({class:"input",type:"date",onblur:e=>A.date.start=e.target.value})),f({class:"column"},h({class:"field"},"Date To"),v({class:"input",type:"date",onblur:e=>A.date.end=e.target.value})),f({class:"column"},h({class:"field"},"Amount"),v({class:"input",type:"number",placeholder:"start",oninput:e=>A.amount.start=e.target.value})),f({class:"column"},h({class:"field"},"Amount"),v({class:"input",type:"number",placeholder:"end",oninput:e=>A.amount.end=e.target.value}))),f({class:"buttons"},y({class:"button is-primary",type:"button",onclick:()=>u.emit("search",A)},"Apply"),y({class:"button is-secondary",type:"reset",onclick:()=>{A=new a}},"Reset")))),{div:D,header:j,p:C,section:F,footer:I,button:R}=t.tags,E=(e,s)=>{const t=()=>p.close(e.id);return D({id:e.id,class:"modal"},D({class:"modal-background"}),D({class:"modal-card"},j({class:"modal-card-head"},C({class:"modal-card-title"},e.title),R({class:"delete",ariaLabel:"close",onclick:t})),F({class:"modal-card-body"},s),()=>e.footer?I({class:"modal-card-foot"},D({class:"buttons"},R({class:"button is-success",onclick:()=>u.emit("action")},"Save"),R({class:"button",onclick:t},"Cancel"))):D()))},{div:B,label:L,input:N,select:$,option:O}=t.tags,{transaction:P}=l.transaction,{tags:U}=l.tag;u.subscribe("action",function(){l.transaction.saveTransaction().then(()=>{p.close("TransactionModal"),P.val=new n})});let V=$({class:"input",onchange:e=>P.val.tag=e.target.value},O({value:""},""));t.derive(()=>{let e=new Array;e=U.val.map(e=>O({value:e,selected:()=>P.val.tag===e},e)),t.add(V,e)});const{div:q,input:G,label:H,span:J,strong:K}=t.tags,Q=()=>{function e(e){e.preventDefault(),e.stopPropagation(),document.getElementsByClassName("dropzone")[0].classList.remove("is-dragover")}function s(e){const s=new FileReader;s.addEventListener("load",e=>{const s=e.target.result;if(s&&"string"==typeof s){let e=0,t=new Array;const a=new Array;s.replaceAll("\r","").split("\n").forEach(s=>{var l;if(0===e)t=s.replaceAll('"',"").replace("Date","dttm").toLowerCase().split(",");else{const e=s.replaceAll('"',"").split(",");let o=0;const i={};for(const s of t)i[s]=e[o],o+=1;i.amount=parseFloat(null==(l=i.amount)?void 0:l.toString());let c=new n(i);c.dttm&&c.name&&a.push(c)}e+=1}),l.transaction.saveTransactions(a).then(e=>{200===e&&(document.getElementsByClassName("dropzone")[0].classList.remove("is-uploading"),document.getElementsByClassName("dropzone")[0].classList.add("is-success"),window.setTimeout(()=>window.location.reload(),1e3))})}}),s.readAsText(e)}return q({class:()=>window.FileReader?"dropzone has-advanced-upload":"dropzone",style:"text-align: center;",ondragover:e=>{e.preventDefault(),e.stopPropagation(),document.getElementsByClassName("dropzone")[0].classList.add("is-dragover")},ondrop:e=>function(e){e.preventDefault(),document.getElementsByClassName("dropzone")[0].classList.remove("is-dragover"),document.getElementsByClassName("dropzone")[0].classList.add("is-uploading"),e.dataTransfer&&e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{if("file"===e.kind){const t=e.getAsFile();t&&s(t)}}):e.dataTransfer&&e.dataTransfer.files&&[...e.dataTransfer.files].forEach(e=>{s(e)})}(e),ondragend:s=>e(s),ondragleave:s=>e(s)},q({class:"dropzone__input"},o({class:"dropzone__icon"}),G({type:"file",name:"files[]",id:"file",class:"dropzone__file",multiple:"",onchange:()=>function(){const e=document.getElementById("file");e&&e.files&&[...e.files].forEach(e=>{"text/csv"==e.type&&s(e)})}()}),H({for:"file"},K("Choose a file"),J({class:"dropzone__dragndrop"}," or drag it here"),".")),q({class:"dropzone__uploading"},"Uploading..."),q({class:"dropzone__success"},"Done!"),q({class:"dropzone__error"},"Error"))},{div:W,a:X}=t.tags;t.tags;const{div:Y,button:Z,a:ee,hr:se}=t.tags,{div:te,table:ae,thead:le,tbody:ne,tfoot:oe,tr:ie,th:ce,td:re,button:de,input:ue,select:pe,option:me,span:ge}=t.tags,be=e=>{const{tags:s}=l.tag,{transaction:a}=l.transaction;let o=t.state(0),b=t.state(0),f=t.state(0);function h(){l.transaction.saveTransaction().then(()=>{o.val=0})}u.subscribe("edit",e=>async function(e){a.val=new n,e>0&&await l.transaction.getTransactionById(e);p.open("TransactionModal")}(e)),u.subscribe("remove",e=>function(e){e>0&&g({title:"Confirm",message:"Are you sure you want to remove this transaction?",type:"yesno"}).then(s=>{s&&l.transaction.removeTransaction(e).then(()=>{window.location.reload()})})}(e)),u.subscribe("tag",s=>{let t=e.transactions.find(e=>e.id==s)??new n;l.tag.setRule(t.name,{amount:Math.abs(t.amount),tag:""}),p.open("RuleBuilderModal")}),f.val=0;const v=new Array;return e.transactions.forEach(e=>{f.val=f.val+parseFloat(e.amount.toString()),v.push(ie(re(te({class:"text-nowrap"},e.dttm)),re(e.transaction),re(te({style:"max-width:350px",class:"text-ellipsis",title:e.name},e.name)),re(()=>o.val!=e.id?de({class:"button is-small text-ellipsis",style:"max-width:130px;display:block",title:e.memo,onclick:()=>{a.val=e,o.val=e.id}},e.memo):ue({type:"text",class:"input",value:()=>e.memo,oninput:s=>{e.memo=s.target.value,a.val.memo=e.memo},onblur:()=>h(),onkeyup:e=>{e.key.includes("Enter")&&h()}})),re(e.amount),re(()=>b.val!=e.id?de({class:"button is-small",onclick:()=>{a.val=e,b.val=e.id}},e.tag):pe({class:"input",onblur:()=>b.val=0,onchange:s=>{e.tag=s.target.value,a.val.tag=e.tag,l.transaction.saveTransaction().then(()=>{b.val=0})}},me({value:""},""),s.val.map(s=>me({value:s,selected:e.tag===s},s)))),re((e=>{let s=t.state(!1);return Y(Z({type:"button",onclick:()=>{s.val=!s.val}},i()),Y({class:()=>s.val?"mini-menu active":"mini-menu"},Y({class:""},ee({class:"mini-menu-item",href:"#",onclick:t=>{t.preventDefault(),s.val=!1,u.emit("edit",e.id)}},c(),"Edit Transaction"),ee({class:"mini-menu-item",href:"#",onclick:t=>{t.preventDefault(),s.val=!1,u.emit("tag",e.id)}},r(),"Create Tag"),se({class:"mini-menu-divider"}),ee({style:"color: hsl(348deg,100%,70%)",class:"mini-menu-item",href:"#",onclick:t=>{t.preventDefault(),s.val=!1,u.emit("remove",e.id)}},d(),"Delete Transaction"))))})({id:e.id}))))}),te({},te({class:"column"},te({class:"table-container"},ae({class:"table is-striped is-narrow is-fullwidth is-hoverable"},le(ie(ce("Date"),ce("Transaction"),ce("Name"),ce("Memo"),ce("Amount"),ce("Tag"),ce(de({class:"button is-secondary is-small",onclick:()=>p.open("ImportModal")},"Import")))),()=>0===e.transactions.length?ne(ie(re({colSpan:8},"No records found."))):ne(v),oe(ie(re({colSpan:4},""),re({colSpan:3},ge({class:"has-text-weight-bold"},"$",Math.abs(f.val).toFixed(2)))))))),E({id:"TransactionModal",title:"Transaction Properties",footer:!0},B(B(L("Date"),N({type:"text",class:"input",disabled:!0,value:()=>P.val.dttm})),B(L("Transaction"),N({type:"text",class:"input",disabled:!0,value:()=>P.val.transaction})),B(L("Name"),N({type:"text",class:"input",disabled:!0,value:()=>P.val.name})),B(L("Memo"),N({type:"text",class:"input",placeholder:"Enter memo.",value:()=>P.val.memo,oninput:e=>P.val.memo=e.target.value})),B(L("Amount"),N({type:"text",class:"input",disabled:!0,value:()=>P.val.amount})),B(L("Tag"),V))),E({id:"ImportModal",title:"Import Transactions"},W(X({href:"./template.csv",traget:"_blank",class:"button is-small mb-4"},"CSV template"),Q())),E({id:"RuleBuilderModal",title:"Tag Rule Builder"},m()))},{div:fe,nav:he,ul:ve,li:ye,span:we,a:ke,select:xe,option:ze}=t.tags;let Te=new a;const _e=e=>{const s=new b(e);let a=t.state(new Array);let l=t.state(1),n=t.state(s.total);if(n.val>3){let e=Math.ceil(1.5)-1,t=s.page-e,a=s.page+e;t<2?(a=3,t=1):a>s.total-2&&(a=s.total,t=s.total-3+1),l.val=t,n.val=a}a.val=[],l.val>2?(a.val.push(1),a.val.push(0)):l.val>1&&a.val.push(1);for(let t=l.val;t<=n.val;t++)a.val.push(t);return n.val<s.total&&(a.val.push(0),a.val.push(s.total)),fe({class:"mb-4"},fe({class:"is-pulled-right"},xe({class:"input",title:"page size",onchange:e=>{Te.page=1,Te.pagesize=parseInt(e.target.value,10),u.emit("page",Te)}},[25,50,100].map(s=>ze({selected:(null==e?void 0:e.pagesize)==s},s)))),he({class:"pagination is-small is-rounded",role:"navigation",ariaLabel:"pagination"},ve({class:"pagination-list"},a.val.map(e=>ye(e?ke({href:"#",ariaLabel:`goto page ${e}`,class:()=>e===s.page?"pagination-link is-current":"pagination-link",onclick:s=>{s.preventDefault(),Te.page=e,u.emit("page",Te)}},e):we({class:"pagination-ellipsis"},"â€¦"))))))},{div:Ae}=t.tags;let Me=t.state(!1),Se=t.state({filter:new a,data:new Array});function De(e,s=0){switch(s){case 0:Se.val.filter=e;break;case 1:Se.val.filter.page=e.page,Se.val.filter.pagesize=e.pagesize}Me.val=!0,l.transaction.getTransactions(Se.val.filter).then(e=>{Se.val=e,Me.val=!1})}u.subscribe("search",e=>De(e)),u.subscribe("page",e=>De(e,1));const je=async()=>(Se.val=await l.transaction.getTransactions(),Ae({class:"container mt-2"},S(),()=>Me.val?Ae({class:"skeleton-block"}):Ae(_e({page:Se.val.filter.page,pagesize:Se.val.filter.pagesize,total:Se.val.filter.pagecount}),be({transactions:Se.val.data}),_e({page:Se.val.filter.page,pagesize:Se.val.filter.pagesize,total:Se.val.filter.pagecount}))));export{je as Transactions};
